<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js"></script>
    <title>Appointement Book</title>
    <style>
:root {
            --cor0: #654321;
            --cor1: #662C22;
            --cor2: #663822;
            --cor3: #665622;
            --cor4: #664E22;

            --main-bg-color: #f2f2f2;
            --main-font-color: #333;
            --main-button-bg-color: #4CAF50;
            --main-button-color: #ffffff;
            
            --fonte-titulos: 'Playfair Display', serif, Arial, Helvetica, sans-serif;
            --fonte-subtitulos: 'Roboto', sans-serif, Arial, Helvetica, sans-serif;
            --fonte-texto: 'Lora', serif, Arial, Helvetica, sans-serif;
        }

@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap');        
        /* CSS para o formulário de agendamento */
body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    margin: 0;
    font-family: Arial, sans-serif;
    background-image: url(imagens/foto-appointement.jpg);
    background-size: cover;
    background-position: center;
}

.container {
    background-color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 280px;
    width: 290px;
}

header {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}

header img {
    max-width: 105%;
    height: auto;
}

form {
    width: 800px;
    padding: 20px;
    background-color: #ffffff;
    border-radius: 30px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

h1 {
    text-align: center;
    margin-bottom: 20px;
    font-family: 'Orbitron', sans-serif, Arial, Helvetica, sans-serif;
    font-variant: small-caps;
}

label {
    display: block;
    margin: 10px 0 5px;
}

input[type="text"],
input[type="email"],
input[type="date"],
input[type="datetime-local"] {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

select {
    width: calc(103% - 20px);
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

input[type="submit"] {
    width: 100%;
    padding: 10px;
    border: none;
    background-color: var(--cor0);
    color: #fff;
    border-radius: 5px;
    cursor: pointer;
}

input[type="submit"]:hover {
    background-color: var(--cor4);
}

.xdsoft_datetimepicker {
            font-family: Arial, sans-serif;
            color: var(--main-font-color);
            background-color: var(--main-bg-color);
            width: 100%;
            max-width: 310px;
            border-radius: 8px;
        }
        
        .xdsoft_datetimepicker .xdsoft_datepicker {
            background-color: var(--main-bg-color);
        }
        
        .xdsoft_datetimepicker .xdsoft_timepicker {
            background-color: var(--cor0);
        }
        
        .xdsoft_datetimepicker .xdsoft_calendar td, .xdsoft_datetimepicker .xdsoft_time_box td {
            text-align: center;
        }
        
        .xdsoft_datetimepicker .xdsoft_calendar th, .xdsoft_datetimepicker .xdsoft_time_box th {
            font-weight: normal;
        }
        
        .xdsoft_datetimepicker .xdsoft_calendar td.xdsoft_today, .xdsoft_datetimepicker .xdsoft_time_box td.xdsoft_current {
            background-color: var(--main-button-bg-color);
            color: var(--main-button-color);
        }
        
        .xdsoft_datetimepicker .xdsoft_calendar td.xdsoft_today:before, .xdsoft_datetimepicker .xdsoft_time_box td.xdsoft_current:before {
            background-color: var(--main-button-bg-color);
        }
        
        .xdsoft_datetimepicker .xdsoft_calendar td.xdsoft_disabled, .xdsoft_datetimepicker .xdsoft_time_box td.xdsoft_disabled {
            background-color: #ddd;
        }

        label::After {
            content: '*';
            color: red;
        }        
    </style>
</head>
<body>
    <header>
        <div class="container">
        <a href="barber-shop.html"><img src="imagens/Barber Shop Logo400.png" alt="Barber Logo"></a>
        </div>
    </header>

    <form action="" method="post">
        <h1>Make an Appointement</h1>
        <label for="nome">Name:</label>
        <input type="text" id="nome" name="nome" required placeholder="REQUIRED">
        <label for="email">E-Mail:</label>
        <input type="email" id="email" name="email" required placeholder="REQUIRED">
        <label for="datetimepicker">Date & Time:</label><span id="datetimeError" style="color: red;"></span>
        <input type="text" id="datetimepicker" name="datetime" required placeholder="REQUIRED">
        <input type="submit" value="Submit">
    </form>

    <script>
    // Agendamento de evento ao carregar o DOM
    document.addEventListener("DOMContentLoaded", function() {
        var form = document.querySelector('form');
        var emailInput = document.getElementById('email');

        // Inicialização do seletor de data e hora
        $('#datetimepicker').datetimepicker({
            format: 'Y-m-d H:i',
            formatDate: 'Y-m-d',
            formatTime: 'H:i',
            minDate: 0,
            step: 30,
            allowTimes: getAvailableTimes() // Configuração dos horários disponíveis
        });

        // Adicionar evento de envio de formulário
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Obter valores dos campos
            var nome = document.getElementById('nome').value;
            var email = document.getElementById('email').value.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            
            // Verificações de preenchimento e formato do e-mail
            if (!nome.trim() || !email.trim()) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            if (/[^\w.@]/.test(email.split('@')[1])) {
                alert('Uma parte após o "@" não deve conter caracteres especiais.');
                return;
            }

            if (/[^\w.@]/.test(email)) {
                alert('O e-mail não deve conter caracteres especiais, exceto . e @.');
                return;
            }

            var datetime = datetimepicker.value;

            var newAppointment = {
                nome: nome,
                email: email,
                datetime: datetime
            };

            var appointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            
            // Verificar se o agendamento já existe para a data especificada
            var existingAppointment = appointments.find(function(appointment) {
                return appointment.email === email && appointment.datetime.split(' ')[0] === datetime.split(' ')[0];
            });

            if (existingAppointment) {
                alert('Já existe um agendamento com este e-mail para esta data. Escolha uma data diferente.');
                return;
            }

            // Verificar se o horário está dentro do intervalo permitido (9h - 18h) e em intervalos de 30 minutos
            var time = datetime.split(' ')[1].split(':');
            var minutes = time[1];
            if (time[0] < 9 || time[0] >= 18 || (minutes !== '00' && minutes !== '30')) {
                alert('Por favor, escolha um horário entre 9h e 18h, em intervalos de 30 minutos.');
                return;
            }

            // Adicionar novo agendamento
            appointments.push(newAppointment);

            localStorage.setItem('appointments', JSON.stringify(appointments));
        });
    });

    // Função para obter os horários disponíveis em intervalos de 30 minutos
    function getAvailableTimes() {
        var times = [];
        for (var hour = 9; hour < 18; hour++) {
            times.push(formatTime(hour, 0));
            times.push(formatTime(hour, 30));
        }
        return times;
    }

    // Função para formatar o tempo no formato de horas e minutos
    function formatTime(hour, minutes) {
        return (hour < 10 ? '0' + hour : hour) + ':' + (minutes === 0 ? '00' : minutes);
    }

    // Evento de carregamento do DOM para exibir os agendamentos existentes
    document.addEventListener("DOMContentLoaded", function() {
        var appointments = JSON.parse(localStorage.getItem('appointments'));
        var list = document.getElementById('appointmentList');

        // Mostrar a lista de agendamentos ou uma mensagem se nenhum agendamento for encontrado
        if (appointments) {
            appointments.forEach(function(appointment, index) {
                var listItem = document.createElement('li');
                var appointmentInfo = document.createElement('div');
                appointmentInfo.classList.add('appointment-info');
                var name = document.createElement('p');
                name.textContent = `Nome completo: ${appointment.nome}`;
                var email = document.createElement('p');
                email.textContent = `E-mail: ${appointment.email}`;
                var date = document.createElement('p');
                date.textContent = `Data: ${appointment.datetime.split(' ')[0]}`;
                var time = document.createElement('p');
                time.textContent = `Horário: ${appointment.datetime.split(' ')[1]}`;
                var deleteButton = document.createElement('button');
                deleteButton.textContent = 'Excluir';
                deleteButton.onclick = function() {
                    showConfirmation(index);
                };
                appointmentInfo.appendChild(name);
                appointmentInfo.appendChild(email);
                appointmentInfo.appendChild(date);
                appointmentInfo.appendChild(time);
                listItem.appendChild(appointmentInfo);
                listItem.appendChild(deleteButton);
                list.appendChild(listItem);
            });
        } else {
            var listItem = document.createElement('li');
            listItem.textContent = 'Nenhum agendamento encontrado.';
            list.appendChild(listItem);
        }
    });

    var appointments = JSON.parse(localStorage.getItem('appointments')) || [];

    // Função para mostrar a confirmação de exclusão
    function showConfirmation(index) {
        var confirmationMessage = document.getElementById('confirmationMessage');
        confirmationMessage.style.display = 'flex';
        var yesButton = document.getElementById('yesButton');
        yesButton.onclick = function() {
            confirmDelete(index);
        };
        var noButton = document.getElementById('noButton');
        noButton.onclick = cancelDelete;
    }

    // Função para confirmar a exclusão
    function confirmDelete(index) {
        var appointments = JSON.parse(localStorage.getItem('appointments'));
        appointments.splice(index, 1);
        localStorage.setItem('appointments', JSON.stringify(appointments));
        location.reload();
    }

    // Função para cancelar a exclusão
    function cancelDelete() {
        var confirmationMessage = document.getElementById('confirmationMessage');
        confirmationMessage.style.display = 'none';
    }

    // Adicionar evento de envio de formulário para verificar se um agendamento já existe
    var form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        var nome = document.getElementById('nome').value;
        var email = document.getElementById('email').value;
        var datetime = datetimepicker.value;

        var existingAppointment = appointments.find(function(appointment) {
            return appointment.email === email && appointment.datetime.split(' ')[0] === datetime.split(' ')[0];
        });

        if (existingAppointment) {
            alert('Um agendamento com este e-mail já existe para esta data. Por favor, escolha uma data diferente.');
            return;
        }

        // Verificar se o horário está dentro do intervalo permitido (9h - 18h) e se está em intervalos de 30 minutos
        var time = datetime.split(' ')[1].split(':');
        var minutes = time[1];
        if (time[0] < 9 || time[0] >= 18 || (minutes !== '00' && minutes !== '30')) {
            alert('Por favor, escolha um horário entre 9h e 18h, em intervalos de 30 minutos.');
            return;
        }

        var newAppointment = {
            nome: nome,
            email: email,
            datetime: datetime
        };

        appointments.push(newAppointment);
        localStorage.setItem('appointments', JSON.stringify(appointments));

        var selectOptions = datetimepicker.getElementsByTagName('option');
        for (var i = 0; i < selectOptions.length; i++) {
            if (selectOptions[i].value === datetime.split(' ')[1]) {
                datetimepicker.remove(i);
                break;
            }
        }

        alert('Agendamento salvo com sucesso!');
        form.reset();
    });
    </script>
</body>
</html>